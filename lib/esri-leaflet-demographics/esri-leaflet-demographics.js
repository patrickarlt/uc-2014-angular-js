/*! esri-leaflet-demographics - v0.0.1-beta.1 - 2014-02-27
*   Copyright (c) 2014 Environmental Systems Research Institute, Inc.
*   Apache License*/
!function(L){function a(a,b){b=b||window;for(var c,d=b,e=a.split(".");c=e.shift();)d[c]||(d[c]={}),d=d[c];return d}function b(a,b,c){var d=null;return function(){c=this||c;var e=arguments;clearTimeout(d),d=setTimeout(function(){a.apply(c,e)},b)}}function c(a){var b="";for(var c in a)if(a.hasOwnProperty(c)){var d=c,e=a[c];b+=encodeURIComponent(d),b+="=",b+=encodeURIComponent(e),b+="&"}return b.substring(0,b.length-1)}function d(a,b,d){var e=new XMLHttpRequest;b.f="json",e.onreadystatechange=function(){var a;if(4===e.readyState){try{a=JSON.parse(e.responseText)}catch(b){a={error:"Could not parse response as JSON."}}d(a)}},e.open("POST",a,!0),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.send(c(b))}function e(a,b,d){var e="c"+(1e9*Math.random()).toString(36).replace(".","_");b.f="json",b.callback="L.esri.Demographics._callback."+e;var f=document.createElement("script");f.type="text/javascript",f.src=a+"?"+c(b),f.id=e,L.esri.Demographics._callback[e]=L.Util.bind(function(a){d(a),document.body.removeChild(f),delete L.esri.Demographics._callback[e]},this),document.body.appendChild(f)}a("L.esri.Demographics");var f={_setupMetadata:function(){e("http://arcgis.com/sharing/rest/content/items/"+this.itemId,{},L.bind(function(a){this._serviceUrl=a.url.split("?")[0]+"/",this.options.title||(this.options.title=a.title),this.fire("metadata",{metadata:a,bounds:L.latLngBounds([[a.extent[0][1],a.extent[0][0]],[a.extent[1][1],a.extent[1][0]]])}),this._checkIfReady()},this))},_setupItemData:function(){e("http://arcgis.com/sharing/rest/content/items/"+this.itemId+"/data/",{},L.bind(function(a){this._renderers=[],this._layers={},this._queryFields=a.thematicGroup.fieldNames;for(var b=0;b<a.layers.length;b++){var c=a.layers[b],d=c.layerDefinition;d.id=c.id,this._renderers.push(d),this._layers[c.id]=c.name.replace(/[0-9]/g,"")}this._checkIfReady()},this))},_checkIfReady:function(){this._map&&this._serviceUrl&&this._renderers&&this._update(),!this._ready&&this._serviceUrl&&this._renderers&&(this.ready=!0,this.fire("ready"))},_getScale:function(){var a=39.37,b=96,c=this._map.getBounds(),d=this._map.getSize(),e=this._map.options.crs.project(c._northEast),f=this._map.options.crs.project(c._southWest);return Math.abs(e.x-f.x)/d.x*a*b},_renderersForScale:function(){for(var a=[],b=this._getScale(),c=0;c<this._renderers.length;c++){var d=this._renderers[c];b<=d.minScale&&b>=d.maxScale&&a.push(d)}return a.length||a.push(this._renderers[this._renderers.length-1]),a},_sourceLayerIdForScale:function(){for(var a=this._renderersForScale(),b=0;b<a.length;b++)if(a[b].drawingInfo)return a[b].source.mapLayerId},_getLayerNameByID:function(a){if(this._layers[a])return this._layers[a];for(var b=0;b<this._renderers.length;b++)if(this._renderers[b].source.mapLayerId===a)return this._layers[this._renderers[b].id]}};L.esri.Demographics.DemographicLayer=L.Class.extend({includes:L.Mixin.Events,ready:!1,_fieldCache:[],options:{token:!1,detectRetina:!1,opacity:.5,debounce:150,position:"front"},initialize:function(a,b){if(L.Util.setOptions(this,b),!L.esri.Demographics._keys[a])throw"L.esri.Demographics.DemographicLayer: A key from a layer file is required";this.itemId=L.esri.Demographics._keys[a],this._setupItemData(),this._setupMetadata()},onAdd:function(a){this._map=a,this._moveHandler=b(this._update,this.options.debounce,this),a.on("moveend",this._moveHandler,this),this._update()},onRemove:function(a){this._currentImage&&this._map.removeLayer(this._currentImage),a.off("moveend",this._moveHandler,this)},addTo:function(a){return a.addLayer(this),this},_getImageUrl:function(a){var b=this._map.getBounds(),c=this._map.getSize(),e=this._map.options.crs.project(b._northEast),f=this._map.options.crs.project(b._southWest),g=this.options.detectRetina&&L.Browser.retina?2:1;d(this._serviceUrl+"export",{bbox:[f.x,f.y,e.x,e.y].join(","),size:c.x*g+","+c.y*g,format:"png32",transparent:!0,dpi:96*g,opacity:1,f:"json",bboxSR:3857,imageSR:3857,dynamicLayers:JSON.stringify(this._renderersForScale()),token:this.options.token},L.Util.bind(function(b){!b.error||499!==b.error.code&&498!==b.error.code?a(b):this._authenticating||(this._authenticating=!0,this.fire("authenticationrequired",{retry:L.Util.bind(function(b){this._authenticating=!1,this.options.token=b,this._getImageUrl(a)},this)}))},this))},_update:function(){var a=this._map.getZoom();if(!this._serviceUrl||!this._renderers)return!1;if(!this._animatingZoom&&!(this._map._panTransition&&this._map._panTransition._inProgress||a>this.options.maxZoom||a<this.options.minZoom)){var b=this._map.getBounds();b._southWest.wrap(),b._northEast.wrap(),this._getImageUrl(L.Util.bind(function(a){var c=new L.ImageOverlay(a.href+"?token="+this.options.token,b,{opacity:0}).addTo(this._map);c.once("load",function(a){var c=a.target,d=this._currentImage;c._bounds.equals(this._map.getBounds())?(this.fire("newimage"),this._currentImage=c,"front"===this.options.position?this._currentImage.bringToFront():this._currentImage.bringToBack(),this._currentImage.setOpacity(this.options.opacity),d&&this._map.removeLayer(d)):this._map.removeLayer(c),this.fire("load",{bounds:b})},this)},this)),this.fire("loading",{bounds:b})}},query:function(a,b){this.ready?this._runQuery(a,b):this.once("ready",L.Util.bind(function(){this._runQuery(a,b)},this))},getAttribution:function(){return'demographic data from <a href="http://www.arcgis.com/features/maps/index.html">Esri</a>'},_runQuery:function(a,b){var c=this._serviceUrl+"dynamicLayer/query",f=this._sourceLayerIdForScale(),g={f:"json",returnGeometry:!0,spatialRel:"esriSpatialRelWithin",geometry:a.lng+","+a.lat,geometryType:"esriGeometryPoint",inSR:4326,outSR:4326,layer:JSON.stringify({source:{type:"mapLayer",mapLayerId:f}}),token:this.options.token},h=L.Util.bind(function(a){for(var b={type:"FeatureCollection",features:[]},c=a.features.length-1;c>=0;c--){var d=a.features[c],e={type:"Feature",id:d.attributes.ID,geometry:{type:"Polygon",coordinates:d.geometry.rings},properties:{}};for(var g in d.attributes)d.attributes.hasOwnProperty(g)&&(e.properties[g]={fieldName:g,value:d.attributes[g],description:a.fieldAliases[g]});e.properties.LAYER_NAME={fieldName:"LAYER_NAME",value:this._getLayerNameByID(f),description:"Map layer"},b.features.push(e)}return b},this),i=L.Util.bind(function(c){!c.error||499!==c.error.code&&498!==c.error.code?b(c.error?c:h(c)):this._authenticating||(this._authenticating=!0,this.fire("authenticationrequired",{retry:L.Util.bind(function(c){this._authenticating=!1,this.options.token=c,this._runQuery(a,b)},this)}))},this);this._fieldCache[f]?(g.outFields=this._fieldCache[f],d(c,g,i)):e(this._serviceUrl+f,{f:"json",token:this.options.token},L.Util.bind(function(e){if(!e.error||499!==e.error.code&&498!==e.error.code){for(var h=[],j=0;j<e.fields.length;j++){var k=e.fields[j];this._queryFields.indexOf(k.name)>=0&&h.push(k.name)}this._fieldCache[f]=h,g.outFields=h,d(c,g,i)}else this._authenticating||(this._authenticating=!0,this.fire("authenticationrequired",{retry:L.Util.bind(function(c){this._authenticating=!1,this.options.token=c,this.query(a,b)},this)}))},this))}}),L.esri.Demographics.DemographicLayer.include(f),L.esri.Demographics.demographicLayer=function(a,b){return new L.esri.Demographics.DemographicLayer(a,b)},L.esri.Demographics._callback={},L.esri.Demographics._keys={},L.esri.Demographics._addKeys=function(a){for(var b=a.length-1;b>=0;b--)L.esri.Demographics._keys[a[b].key]=a[b].id},L.esri.Demographics.Legend=L.Control.extend({includes:L.Mixin.Events,ready:!1,options:{position:"bottomleft"},initialize:function(a,b){if(L.Util.setOptions(this,b),!L.esri.Demographics._keys[a])throw"L.esri.DemographicLayer: A key is required";this.itemId=L.esri.Demographics._keys[a],this._setupItemData(),this._setupMetadata()},onAdd:function(a){return this._map=a,this._container=L.DomUtil.create("div","esri-legend-container leaflet-bar"),this._update(),this._container},onRemove:function(a){this._currentImage&&this._map.removeLayer(this._currentImage),a.off("moveend",this._moveHandler,this)},renderLegend:function(a){this.fire("load"),this._container.innerHTML="";for(var b=0;b<a.layers.length;b++){var c=a.layers[b];if(c.legend.length&&c.legend[0].label&&c.legend[0].label){var d=L.DomUtil.create("div","esri-legend-layer",this._container);L.DomUtil.create("h4","esri-legend-header",d).textContent=this.options.title;for(var e=L.DomUtil.create("ul","esri-legend-list",d),f=0;f<c.legend.length;f++){var g=c.legend[f];if(g.label&&g.imageData){var h=L.DomUtil.create("li","esri-legend-list-item",e);L.DomUtil.create("img","esri-legend-image",h).src="data:"+g.contentType+";base64,"+g.imageData,L.DomUtil.create("span","esri-legend-description",h).textContent=g.label}}}}this.fire("render")},_getLegend:function(a){d(this._serviceUrl+"legend",{token:this.options.token,dynamicLayers:JSON.stringify(this._renderersForScale())},a)},_update:function(){this._serviceUrl&&this._renderers&&(this.fire("loading"),this._getLegend(L.Util.bind(function(a){!a.error||499!==a.error.code&&498!==a.error.code?this.renderLegend(a):this._authenticating||(this._authenticating=!0,this.fire("authenticationrequired",{retry:L.Util.bind(function(a){this._authenticating=!1,this.options.token=a,this._update()},this)}))},this)))}}),L.esri.Demographics.Legend.include(f),L.esri.Demographics.legend=function(a,b){return new L.esri.Demographics.Legend(a,b)}}(L);